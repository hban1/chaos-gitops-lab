---
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# chaos-experiment.yaml â€” ì‡¼í•‘ëª° í†µí•© ì¹´ì˜¤ìŠ¤ í…ŒìŠ¤íŠ¸ (ë ˆë²¨ ì „ì²´ ìë™ ì‹¤í–‰)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
- name: ğŸ’£ Unified Chaos Engineering Experiment for App + DB (All Levels)
  hosts: k3s_master
  become: yes

  vars:
    target_namespace: "default"

    # ğŸ”¥ Chaos ì£¼ì…ë¥  êµ¬ê°„ë³„ ì„¤ì • (ë„¤ê°€ ë§Œë“  í‘œë¥¼ ì½”ë“œí™”í•œ ë¶€ë¶„)
    chaos_levels:
      # 0~60%: ì •ìƒ ë¶€í•˜ êµ¬ê°„
      - id: normal
        label: "0~60% (ì •ìƒ ë¶€í•˜)"
        inject_band: "0~60%"
        cpu_load: 40              # ë¹„êµì  ë‚®ì€ ë¶€í•˜
        chaos_duration: 30        # 30ì´ˆ
        network_delay_ms: 200     # 200ms ì •ë„ ê²½ë¯¸í•œ ì§€ì—°
        mttr_target: "10~30ì´ˆ"
        note: "ê¸°ë³¸ ê°ì§€ ë£¨í”„ ë° self-healing í™•ì¸"

      # 61~80%: Warning Zone
      - id: warning
        label: "61~80% (Warning Zone)"
        inject_band: "61~80%"
        cpu_load: 70
        chaos_duration: 45
        network_delay_ms: 500
        mttr_target: "30~45ì´ˆ"
        note: "ì•ŒëŒ + ìë™ ë³µêµ¬ ì™„ì „ ì‘ë™ êµ¬ê°„"

      # 81~90%: í•œê³„ ë¶€í•˜ êµ¬ê°„ (í‘œì—ì„œ â€˜íŒë§¤/ê²€ì¦ìš© ìµœì â€™)
      - id: critical_threshold
        label: "81~90% (Critical Threshold)"
        inject_band: "81~90%"
        cpu_load: 90
        chaos_duration: 60
        network_delay_ms: 1000
        mttr_target: "45~60ì´ˆ"
        note: "ë°ëª¨/ì‹œì—°ìš© ìµœì  í•œê³„ ë¶€í•˜"

      # 91~95%: ë¶ˆì•ˆì • êµ¬ê°„
      - id: degraded
        label: "91~95% (Degraded Mode)"
        inject_band: "91~95%"
        cpu_load: 95
        chaos_duration: 90
        network_delay_ms: 1200
        mttr_target: "60~90ì´ˆ"
        note: "ë³µêµ¬ ì§€ì—°, ì•ŒëŒ ë°˜ë³µ êµ¬ê°„"

      # 96~99%: ì„ê³„ í¬í™”
      - id: critical
        label: "96~99% (Critical Mode)"
        inject_band: "96~99%"
        cpu_load: 99
        chaos_duration: 120
        network_delay_ms: 1500
        mttr_target: "90~150ì´ˆ"
        note: "ì¼ë¶€ ë³µêµ¬ ì‹¤íŒ¨, ë°ì´í„° ì†ìƒ ê°€ëŠ¥ êµ¬ê°„"

      # 100%â†‘: ì™„ì „ í¬í™” / Failure Zone
      - id: failure
        label: "100%â†‘ (Failure Zone)"
        inject_band: "100%â†‘"
        cpu_load: 99
        chaos_duration: 300       # 5ë¶„ ì •ë„ ê°•ì œ í¬í™”
        network_delay_ms: 2000
        mttr_target: "5~8ë¶„"
        note: "ìë™ë³µêµ¬ ë¶•ê´´, ìˆ˜ë™ ê°œì… í•„ìˆ˜"

  tasks:
    # chaos_levels ë¦¬ìŠ¤íŠ¸ë¥¼ ëŒë©´ì„œ, ê° ë ˆë²¨ë³„ë¡œ ë„¤ê°€ ì´ë¯¸ ë§Œë“  ì‹œë‚˜ë¦¬ì˜¤ë¥¼ ì‹¤í–‰
    - name: "ğŸš€ Chaos Level ì‹¤í–‰: {{ level.label }}"
      block:
        - name: "ğŸ“Œ ë ˆë²¨ ë©”íƒ€ ì •ë³´ ì¶œë ¥ ({{ level.inject_band }})"
          debug:
            msg: |
              â–¶ Chaos Level: {{ level.label }}
              - ì£¼ì…ë¥  êµ¬ê°„: {{ level.inject_band }}
              - CPU ë¶€í•˜: {{ level.cpu_load }}%
              - Chaos Duration: {{ level.chaos_duration }}ì´ˆ
              - Network Delay: {{ level.network_delay_ms }}ms
              - ëª©í‘œ MTTR: {{ level.mttr_target }}
              - ë¹„ê³ : {{ level.note }}

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ğŸ§© APP / REDIS Layer
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ğŸ’€ 1. cartservice Pod Kill ({{ level.label }})
          include_role:
            name: chaos_kill
          vars:
            target_pod: "cartservice"
            namespace: "{{ target_namespace }}"
          tags: [cartservice, kill]

        - name: ğŸŒ 2. redis-cart Network Latency ({{ level.label }})
          include_role:
            name: chaos_network
          vars:
            target_pod: "redis-cart"
            delay_ms: "{{ level.network_delay_ms }}"
            duration: "{{ level.chaos_duration }}"
            namespace: "{{ target_namespace }}"
          tags: [redis, network]

        - name: ğŸ’€ 3. paymentservice Kill ({{ level.label }})
          include_role:
            name: chaos_kill
          vars:
            target_pod: "paymentservice"
            namespace: "{{ target_namespace }}"
          tags: [payment, kill]

        - name: ğŸ”¥ 4. checkoutservice CPU Stress ({{ level.label }})
          include_role:
            name: chaos_cpu
          vars:
            target_pod: "checkoutservice"
            cpu_load: "{{ level.cpu_load }}"
            duration: "{{ level.chaos_duration }}"
            namespace: "{{ target_namespace }}"
          tags: [checkout, cpu]

        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        # ğŸ§© RDB / ORDER-HISTORY Layer
        # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        - name: ğŸ’€ 5. orders-db Pod Kill ({{ level.label }})
          include_role:
            name: chaos_kill
          vars:
            target_pod: "orders-db"
            namespace: "{{ target_namespace }}"
          tags: [ordersdb, kill]

        - name: ğŸŒ 6. orders-db Network Isolation ({{ level.label }})
          include_role:
            name: chaos_network
          vars:
            target_pod: "orders-db"
            delay_ms: 0                     # ì™„ì „ ì°¨ë‹¨
            duration: "{{ level.chaos_duration }}"
            drop_mode: true                 # tc/qdisc drop ëª¨ë“œ
            namespace: "{{ target_namespace }}"
          tags: [ordersdb, network, isolation]

        - name: ğŸŒ 7. orders-db Network Latency ({{ level.label }})
          include_role:
            name: chaos_network
          vars:
            target_pod: "orders-db"
            delay_ms: "{{ level.network_delay_ms }}"
            duration: "{{ level.chaos_duration }}"
            namespace: "{{ target_namespace }}"
          tags: [ordersdb, latency]

        - name: âš™ï¸ 8. orders-db Connection Pool Exhaustion ({{ level.label }})
          shell: |
            POD=$(kubectl get pod -n {{ target_namespace }} -l app=orders-db -o name | head -n 1)
            kubectl exec -n {{ target_namespace }} $POD -- psql -U postgres -d orderdb -c "ALTER SYSTEM SET max_connections = 5;"
            kubectl rollout restart statefulset orders-db -n {{ target_namespace }}
          ignore_errors: yes
          tags: [ordersdb, config]

        - name: âœ… Chaos Level {{ level.label }} ì™„ë£Œ ìš”ì•½
          debug:
            msg: |
              âœ… Chaos Level ì™„ë£Œ: {{ level.label }}
              â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
              - cartservice       â†’ Pod Kill
              - redis-cart        â†’ Network Delay ({{ level.network_delay_ms }}ms)
              - paymentservice    â†’ Pod Kill
              - checkoutservice   â†’ CPU {{ level.cpu_load }}% / {{ level.chaos_duration }}s
              - orders-db         â†’ Pod Kill + Network + Config
              - ëª©í‘œ MTTR         â†’ {{ level.mttr_target }}
              - ì£¼ì…ë¥  êµ¬ê°„       â†’ {{ level.inject_band }}

      loop: "{{ chaos_levels }}"
      loop_control:
        loop_var: level
        label: "{{ level.label }}"
